# ADR-001: استخدام UUID كمعرف أساسي للشكاوى

**التاريخ:** 2025-09-26  
**الحالة:** مقبول  
**المقرر:** فريق تطوير نائبك  

## السياق والمشكلة

في نظام إدارة الشكاوى، نحتاج إلى معرف فريد لكل شكوى يحقق المتطلبات التالية:
- **الأمان:** عدم إمكانية تخمين معرفات الشكاوى الأخرى
- **التوسع:** دعم النظام للنمو والتوزيع على خوادم متعددة
- **الخصوصية:** حماية معلومات المستخدمين من التسريب
- **سهولة الاستخدام:** توفير رقم مرئي للمستخدمين

## البدائل المدروسة

### البديل الأول: Auto-incrementing Integer
**المزايا:**
- بساطة التطبيق
- سرعة في الاستعلامات
- حجم صغير في قاعدة البيانات
- سهولة الفهم للمطورين

**العيوب:**
- **مشكلة أمنية كبيرة:** يمكن تخمين معرفات الشكاوى الأخرى
- صعوبة في التوزيع على خوادم متعددة
- تسريب معلومات عن حجم النظام
- تضارب في المعرفات عند دمج قواعد البيانات

### البديل الثاني: UUID (Universally Unique Identifier)
**المزايا:**
- **أمان عالي:** استحالة تخمين المعرفات
- دعم التوزيع والتوسع
- عدم الحاجة لتنسيق مركزي
- معيار عالمي مدعوم

**العيوب:**
- حجم أكبر (36 حرف مقابل أرقام صغيرة)
- أداء أبطأ قليلاً في الفهرسة
- صعوبة في القراءة للمستخدمين

### البديل الثالث: Hybrid Approach (UUID + Display Number)
**المزايا:**
- يجمع مزايا النهجين
- أمان UUID مع سهولة استخدام الأرقام
- مرونة في العرض

**العيوب:**
- تعقيد إضافي في التطبيق
- حاجة لإدارة نظامين

## القرار المتخذ

تم اختيار **البديل الثالث: Hybrid Approach** مع التطبيق التالي:

### التطبيق التقني:
```python
class Complaint(models.Model):
    # المعرف الأساسي - UUID للأمان
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # الرقم المرئي للمستخدمين
    complaint_number = models.CharField('رقم الشكوى', max_length=20, unique=True, blank=True)
    
    def save(self, *args, **kwargs):
        # إنشاء رقم الشكوى تلقائياً
        if not self.complaint_number:
            year = timezone.now().year
            count = Complaint.objects.filter(created_at__year=year).count() + 1
            self.complaint_number = f"C{year}{count:06d}"
        super().save(*args, **kwargs)
```

### نمط الترقيم:
- **UUID:** للاستخدام الداخلي والـ APIs
- **Display Number:** `C2025000001` (C + السنة + رقم تسلسلي)

## المبررات

1. **الأمان المتقدم:**
   - UUID يمنع تخمين معرفات الشكاوى الأخرى
   - حماية من هجمات Enumeration
   - عدم تسريب معلومات عن حجم النظام

2. **سهولة الاستخدام:**
   - رقم مرئي سهل القراءة والتذكر
   - يمكن استخدامه في المراسلات والمكالمات
   - يحتوي على السنة لسهولة التصنيف

3. **التوسع والأداء:**
   - دعم التوزيع على خوادم متعددة
   - عدم الحاجة لتنسيق مركزي
   - إمكانية دمج قواعد البيانات دون تضارب

4. **المرونة:**
   - يمكن تغيير نمط الترقيم المرئي دون تأثير على النظام
   - دعم أنماط ترقيم مختلفة حسب نوع الشكوى

## العواقب

### النتائج الإيجابية:
- **أمان محسن:** حماية قوية ضد الوصول غير المصرح
- **تجربة مستخدم أفضل:** أرقام سهلة الاستخدام
- **قابلية التوسع:** دعم النمو المستقبلي
- **مرونة التطوير:** سهولة التطوير والصيانة

### النتائج السلبية:
- **تعقيد إضافي:** نظامان للمعرفات
- **استهلاك ذاكرة أكبر:** UUID أكبر من Integer
- **أداء أبطأ قليلاً:** في بعض الاستعلامات

### استراتيجيات التخفيف:
1. **تحسين الأداء:**
   - استخدام فهارس محسنة للـ UUID
   - تخزين مؤقت للاستعلامات الشائعة

2. **تبسيط التطوير:**
   - إنشاء دوال مساعدة للتعامل مع المعرفات
   - توثيق واضح لاستخدام كل نوع معرف

3. **مراقبة الأداء:**
   - قياس أداء الاستعلامات بانتظام
   - تحسين الفهارس حسب الحاجة

## المراجعة والتقييم

### معايير النجاح:
- عدم حدوث تسريب للشكاوى
- رضا المستخدمين عن سهولة الاستخدام
- أداء مقبول للنظام

### جدولة المراجعة:
- **مراجعة أولى:** بعد 3 أشهر من التطبيق
- **مراجعة دورية:** كل 6 أشهر
- **مراجعة عند الحاجة:** عند مشاكل الأداء أو الأمان

## المراجع

- [RFC 4122: UUID Specification](https://tools.ietf.org/html/rfc4122)
- [Django UUIDField Documentation](https://docs.djangoproject.com/en/stable/ref/models/fields/#uuidfield)
- [OWASP: Insecure Direct Object References](https://owasp.org/www-project-top-ten/2017/A5_2017-Broken_Access_Control)

---

**آخر تحديث:** 2025-09-26  
**المسؤول:** فريق تطوير نائبك
